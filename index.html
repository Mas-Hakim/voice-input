<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ DeepSeek</title>
    <style>
        :root {
            --deepseek-bg: #0a0a0a;
            --deepseek-surface: #1a1a1a;
            --deepseek-border: #2a2a2a;
            --deepseek-primary: #00b894;
            --deepseek-text: #e0e0e0;
            --deepseek-text-secondary: #888;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--deepseek-bg);
            color: var(--deepseek-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        voice-input {
            display: grid;
            grid-template-rows: 1fr auto;
            gap: 20px;
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            background: var(--deepseek-surface);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--deepseek-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        textarea {
            width: 94%;
            height: 80%;
            min-height: 300px;
            background: var(--deepseek-bg);
            border: 1px solid var(--deepseek-border);
            border-radius: 8px;
            color: var(--deepseek-text);
            font-size: 1rem;
            line-height: 1.6;
            padding: 20px;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        textarea:focus {
            border-color: var(--deepseek-primary);
        }
        
        #voice-input {
            background: linear-gradient(135deg, var(--deepseek-primary), #00a884);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #voice-input:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.3);
        }
        
        #voice-input:active {
            transform: translateY(0);
        }
        
        #voice-input.listening {
            background: linear-gradient(135deg, #ff7675, #e17055);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 118, 117, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); }
        }
        
        .status-indicator {
            font-size: 0.9rem;
            color: var(--deepseek-text-secondary);
            text-align: center;
            margin-top: 10px;
            height: 20px;
        }
        
        .status-indicator.active {
            color: var(--deepseek-primary);
        }
        
        .status-indicator.error {
            color: #ff7675;
        }
        
        .info-box {
            background: var(--deepseek-bg);
            border: 1px solid var(--deepseek-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .info-box ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .info-box li {
            margin: 5px 0;
        }
        
        @media (max-width: 480px) {
            voice-input {
                padding: 16px;
            }
            
            textarea {
                min-height: 250px;
                padding: 16px;
            }
            
            #voice-input {
                padding: 14px 24px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <voice-input>
        <div class="info-box">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –î–ª—è —Ä–∞–±–æ—Ç—ã –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
            <ul>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS (https://–≤–∞—à-–¥–æ–º–µ–Ω)</li>
                <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ localhost –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</li>
                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ</li>
            </ul>
        </div>
        <textarea id="voice-output" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
        <div class="status-indicator" id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        <button id="voice-input">Voice Input OFF</button>
    </voice-input>

<script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;
    let isInitialized = false;

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function requestMicrophoneAccess() {
        try {
            updateStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'active');
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
            stream.getTracks().forEach(track => track.stop());
            
            updateStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏', 'active');
            return true;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
            
            if (error.name === 'NotAllowedError') {
                updateStatus('‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'error');
            } else {
                updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
            
            document.getElementById('voice-input').disabled = true;
            return false;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    function initializeRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Safari.");
        } else {
            const recognition = new SpeechRecognition();
            // –¥–∞–ª–µ–µ –≤–∞—à –∫–æ–¥ (lang, onresult –∏ —Ç.–¥.)
        }
        
        // –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
        recognition.lang = 'ru-RU';
        recognition.continuous = true; // –í–∫–ª—é—á–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
        recognition.interimResults = false; // –¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        recognition.maxAlternatives = 1;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
        recognition.interimResults = true; // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏

        recognition.onstart = () => {
            console.log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ');
            isListening = true;
            updateUI();
            updateStatus('üé§ –°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å', 'active');
        };

        recognition.onresult = (event) => {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω:', event.results);
            
            let finalTranscript = '';
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                const transcript = result[0].transcript;
                
                if (result.isFinal) {
                    finalTranscript += transcript;
                    console.log('–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç:', transcript);
                } else {
                    interimTranscript += transcript;
                    console.log('–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç:', transcript);
                }
            }
            
            const output = document.getElementById('voice-output');
            const currentText = output.value;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (finalTranscript) {
                const newText = currentText + (currentText && !currentText.endsWith(' ') ? ' ' : '') + finalTranscript.trim();
                output.value = newText;
                updateStatus('‚úÖ –¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω', 'active');
                output.scrollTop = output.scrollHeight;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ
            if (interimTranscript && !finalTranscript) {
                updateStatus('üé§ –†–∞—Å–ø–æ–∑–Ω–∞—é: ' + interimTranscript, 'active');
            }
        };

        recognition.onerror = (event) => {
            console.log('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
            
            if (event.error === 'no-speech') {
                // –¢–∏—à–∏–Ω–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                updateStatus('üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ –≥—Ä–æ–º—á–µ...', 'active');
                return;
            }
            
            if (event.error === 'audio-capture') {
                updateStatus('üé§ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...', 'active');
                return;
            }
            
            if (event.error === 'not-allowed') {
                updateStatus('‚ùå –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', 'error');
                stopListening();
                return;
            }
            
            updateStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + event.error, 'error');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–∫–∞—Ö
            if (isListening) {
                setTimeout(() => {
                    if (recognition && isListening) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:', e);
                        }
                    }
                }, 1000);
            }
        };

        recognition.onend = () => {
            console.log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            
            if (isListening) {
                // –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                setTimeout(() => {
                    if (recognition && isListening) {
                        try {
                            console.log('–ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫...');
                            recognition.start();
                        } catch (e) {
                            console.log('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:', e);
                            isListening = false;
                            updateUI();
                            updateStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                        }
                    }
                }, 300);
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            }
        };
        
        isInitialized = true;
        updateStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏');
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é
    function startListening() {
        if (!recognition) return;
        
        if (!isInitialized) {
            updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'active');
        }
        
        try {
            recognition.start();
            console.log('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
            
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            if (error.toString().includes('start') || error.toString().includes('already')) {
                stopListening();
                setTimeout(() => {
                    initializeRecognition();
                    setTimeout(startListening, 500);
                }, 1000);
            } else {
                updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', 'error');
            }
        }
    }

    function stopListening() {
        isListening = false;
        
        if (recognition) {
            try {
                recognition.stop();
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            }
        }
        
        updateUI();
        updateStatus('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
    document.getElementById('voice-input').onclick = async () => {
        if (!isInitialized) {
            const hasAccess = await requestMicrophoneAccess();
            if (hasAccess) {
                initializeRecognition();
                setTimeout(() => {
                    startListening();
                }, 300);
            }
            return;
        }

        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    };

    function updateUI() {
        const button = document.getElementById('voice-input');
        if (isListening) {
            button.textContent = 'Voice Input ON';
            button.classList.add('listening');
        } else {
            button.textContent = 'Voice Input OFF';
            button.classList.remove('listening');
        }
    }

    function updateStatus(message, className = '') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = 'status-indicator ' + className;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
    document.getElementById('voice-output').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (isListening) {
                stopListening();
            }
        }
    });

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', (e) => {
        // Space –¥–ª—è —Å—Ç–∞—Ä—Ç–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (e.code === 'Space' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('voice-input').click();
        }
        
        // Esc –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (e.code === 'Escape' && isListening) {
            stopListening();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('DOMContentLoaded', () => {
        updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...', 'active');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        const isSecure = window.location.protocol === 'https:' || 
                        window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
        
        if (!isSecure) {
            console.warn('–†–∞–±–æ—Ç–∞ –≤ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. –ú–∏–∫—Ä–æ—Ñ–æ–Ω –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –Ω–æ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ –∫–ª–∏–∫–∞
        initializeRecognition();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateStatus('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏');
    });

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('SpeechRecognition –¥–æ—Å—Ç—É–ø–µ–Ω:', !!SpeechRecognition);
    console.log('–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:', window.isSecureContext);
    console.log('–ü—Ä–æ—Ç–æ–∫–æ–ª:', window.location.protocol);
</script>
    
</body>
</html>
