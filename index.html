<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ DeepSeek</title>
    <style>
        :root {
            --deepseek-bg: #0a0a0a;
            --deepseek-surface: #1a1a1a;
            --deepseek-border: #2a2a2a;
            --deepseek-primary: #00b894;
            --deepseek-text: #e0e0e0;
            --deepseek-text-secondary: #888;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--deepseek-bg);
            color: var(--deepseek-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        voice-input {
            display: grid;
            grid-template-rows: 1fr auto;
            gap: 20px;
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            background: var(--deepseek-surface);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--deepseek-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        textarea {
            width: 94%;
            height: 80%;
            min-height: 300px;
            background: var(--deepseek-bg);
            border: 1px solid var(--deepseek-border);
            border-radius: 8px;
            color: var(--deepseek-text);
            font-size: 1rem;
            line-height: 1.6;
            padding: 20px;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        textarea:focus {
            border-color: var(--deepseek-primary);
        }
        
        #voice-input {
            background: linear-gradient(135deg, var(--deepseek-primary), #00a884);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #voice-input:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.3);
        }
        
        #voice-input:active {
            transform: translateY(0);
        }
        
        #voice-input.listening {
            background: linear-gradient(135deg, #ff7675, #e17055);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 118, 117, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); }
        }
        
        .status-indicator {
            font-size: 0.9rem;
            color: var(--deepseek-text-secondary);
            text-align: center;
            margin-top: 10px;
            height: 20px;
        }
        
        .status-indicator.active {
            color: var(--deepseek-primary);
        }
        
        .status-indicator.error {
            color: #ff7675;
        }
        
        .info-box {
            background: var(--deepseek-bg);
            border: 1px solid var(--deepseek-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .info-box ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .info-box li {
            margin: 5px 0;
        }
        
        .info-box small {
            margin: 5px 0;
            color: var(--deepseek-border);
        }
        
        @media (max-width: 480px) {
            voice-input {
                padding: 16px;
            }
            
            textarea {
                min-height: 250px;
                padding: 16px;
            }
            
            #voice-input {
                padding: 14px 24px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <voice-input>
        <div class="info-box">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –î–ª—è —Ä–∞–±–æ—Ç—ã –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
            <ul>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS (https://–≤–∞—à-–¥–æ–º–µ–Ω)</li>
                <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ localhost –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</li>
                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ</li>
            </ul>
            <small> –≤–µ—Ä—Å–∏—è: 0.3</small>
        </div>

        <textarea id="voice-output" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
        <div class="status-indicator" id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        
        <div class="controls">
            <button id="voice-input">Voice Input OFF</button>
            <!-- –≠—Ç–æ—Ç div –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç–æ–º -->
            <div class="language-controls"></div>
        </div> 
        
    </voice-input>

<script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;
    let isInitialized = false;
    let currentLanguage = 'ru-RU';

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
    async function requestMicrophoneAccess() {
        try {
            updateStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'active');
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            console.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
            stream.getTracks().forEach(track => track.stop());
            
            updateStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏', 'active');
            return true;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
            
            if (error.name === 'NotAllowedError') {
                updateStatus('‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞', 'error');
            } else {
                updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
            
            document.getElementById('voice-input').disabled = true;
            return false;
        }
    }

    // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞
    const languageDetectPatterns = {
        'english': /^[a-zA-Z\s]+$/, // –¢–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã
        'mixed': /[a-zA-Z].*[–∞-—è–ê-–Ø]|[–∞-—è–ê-–Ø].*[a-zA-Z]/ // –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    };

    // –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞
    function containsEnglish(text) {
        return /[a-zA-Z]/.test(text) && text.length > 2;
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞
    function containsRussian(text) {
        return /[–∞-—è–ê-–Ø]/.test(text) && text.length > 2;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞
    function toggleLanguage() {
        if (currentLanguage === 'ru-RU') {
            currentLanguage = 'en-US';
            updateStatus('üåê –Ø–∑—ã–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π', 'active');
            document.getElementById('lang-toggle').textContent = 'üá∑üá∫ –†—É—Å—Å–∫–∏–π';
        } else {
            currentLanguage = 'ru-RU';
            updateStatus('üåê –Ø–∑—ã–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π', 'active');
            document.getElementById('lang-toggle').textContent = 'üá∫üá∏ English';
        }
        
        if (recognition) {
            recognition.lang = currentLanguage;
            console.log('–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', currentLanguage);
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Ç–µ–∫—Å—Ç–∞
    function detectLanguage(text) {
        const hasEnglish = containsEnglish(text);
        const hasRussian = containsRussian(text);
        
        if (hasEnglish && hasRussian) {
            return 'mixed'; // –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        } else if (hasEnglish) {
            return 'en'; // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
        } else if (hasRussian) {
            return 'ru'; // –†—É—Å—Å–∫–∏–π
        } else {
            return 'unknown';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
    function initializeRecognition() {
        if (!SpeechRecognition) {
            updateStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏', 'error');
            return;
        }

        recognition = new SpeechRecognition();
        
        // –ù–ê–°–¢–†–û–ô–ö–ò –î–õ–Ø –õ–£–ß–®–ï–ì–û –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø –ê–ù–ì–õ–ò–ô–°–ö–ò–• –°–õ–û–í –í –†–£–°–°–ö–û–ô –†–ï–ß–ò
        recognition.lang = 'ru-RU'; // –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ - —Ä—É—Å—Å–∫–∏–π
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 3; // –ë–æ–ª—å—à–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
        recognition.grammars = null; // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –ø–æ–∑–∂–µ

        recognition.onstart = () => {
            console.log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ. –Ø–∑—ã–∫:', currentLanguage);
            isListening = true;
            updateUI();
            updateStatus(`üé§ –°–ª—É—à–∞—é... (${currentLanguage === 'ru-RU' ? '–†—É—Å—Å–∫–∏–π' : '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π'})`, 'active');
        };

        recognition.onresult = (event) => {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω:', event.results);
            
            let finalTranscript = '';
            let bestAlternative = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                
                // –ò—â–µ–º –ª—É—á—à—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
                for (let j = 0; j < result.length; j++) {
                    const alternative = result[j];
                    
                    if (result.isFinal) {
                        // –í—ã–±–∏—Ä–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
                        if (!bestAlternative || alternative.confidence > 0.8) {
                            bestAlternative = alternative.transcript;
                        }
                        
                        // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        console.log(`–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ${j}: "${alternative.transcript}" (confidence: ${alternative.confidence})`);
                    }
                }
                
                if (result.isFinal && bestAlternative) {
                    finalTranscript = bestAlternative;
                    
                    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤
                    const detectedLang = detectLanguage(finalTranscript);
                    
                    if (detectedLang === 'mixed' || detectedLang === 'en') {
                        console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç:', finalTranscript);
                        
                        // –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±—ã–ª–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –Ω–æ –Ω–∞—à–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π -
                        // –≤–æ–∑–º–æ–∂–Ω–æ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ñ—Ä–∞–∑—ã
                        if (currentLanguage === 'ru-RU' && containsEnglish(finalTranscript)) {
                            updateStatus('üåê –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞', 'active');
                        }
                    }
                }
            }
            
            if (finalTranscript) {
                const output = document.getElementById('voice-output');
                const currentText = output.value;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
                const formattedText = formatText(finalTranscript, currentText);
                output.value = formattedText;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —è–∑—ã–∫–µ
                const langInfo = detectLanguage(finalTranscript);
                const langEmoji = langInfo === 'mixed' ? 'üåç' : (langInfo === 'en' ? 'üá∫üá∏' : 'üá∑üá∫');
                updateStatus(`${langEmoji} –¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω (${langInfo})`, 'active');
                
                output.scrollTop = output.scrollHeight;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (!finalTranscript && event.results[event.results.length - 1]) {
                const interim = event.results[event.results.length - 1][0].transcript;
                const langDetected = detectLanguage(interim);
                updateStatus(`üé§ ...${interim.substring(Math.max(0, interim.length - 30))}`, 'active');
            }
        };

        recognition.onerror = (event) => {
            console.log('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
            
            if (event.error === 'no-speech') {
                updateStatus('üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ –≥—Ä–æ–º—á–µ...', 'active');
                return;
            }
            
            if (event.error === 'audio-capture') {
                updateStatus('üé§ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...', 'active');
                return;
            }
            
            if (event.error === 'not-allowed') {
                updateStatus('‚ùå –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', 'error');
                stopListening();
                return;
            }
            
            updateStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞: ' + event.error, 'error');
            
            if (isListening) {
                setTimeout(() => {
                    if (recognition && isListening) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:', e);
                        }
                    }
                }, 1000);
            }
        };

        recognition.onend = () => {
            if (isListening) {
                setTimeout(() => {
                    if (recognition && isListening) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:', e);
                            isListening = false;
                            updateUI();
                            updateStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                        }
                    }
                }, 300);
            } else {
                updateStatus('–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
            }
        };
        
        isInitialized = true;
        updateStatus('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏');
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞
    function formatText(newText, existingText) {
        if (!existingText) return newText;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const newTextLang = detectLanguage(newText);
        const lastChar = existingText.charAt(existingText.length - 1);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
        let separator = ' ';
        
        if (lastChar === '.' || lastChar === '!' || lastChar === '?') {
            separator = ' ';
        } else if (lastChar === ',') {
            separator = ' ';
        } else if (lastChar === ' ') {
            separator = '';
        }
        
        return existingText + separator + newText;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é
    function startListening() {
        if (!recognition) return;
        
        try {
            recognition.start();
            console.log('–ó–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–∞ —è–∑—ã–∫–µ:', currentLanguage);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
            
            if (error.toString().includes('start') || error.toString().includes('already')) {
                stopListening();
                setTimeout(() => {
                    initializeRecognition();
                    setTimeout(startListening, 500);
                }, 1000);
            } else {
                updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å', 'error');
            }
        }
    }

    function stopListening() {
        isListening = false;
        
        if (recognition) {
            try {
                recognition.stop();
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            }
        }
        
        updateUI();
        updateStatus('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
    document.getElementById('voice-input').onclick = async () => {
        if (!isInitialized) {
            const hasAccess = await requestMicrophoneAccess();
            if (hasAccess) {
                initializeRecognition();
                setTimeout(() => {
                    startListening();
                }, 300);
            }
            return;
        }

        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    };

    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ (–¥–æ–±–∞–≤–∏—Ç—å –≤ HTML)
    function createLanguageToggle() {
        const controls = document.querySelector('.controls');
        if (!controls) return;
        
        const langButton = document.createElement('button');
        langButton.id = 'lang-toggle';
        langButton.innerHTML = 'üá∫üá∏ English';
        langButton.style.cssText = `
            background: var(--deepseek-border);
            color: var(--deepseek-text);
            border: 1px solid var(--deepseek-border);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
        `;
        
        langButton.onmouseover = function() {
            this.style.background = 'var(--deepseek-primary)';
            this.style.color = 'white';
        };
        
        langButton.onmouseout = function() {
            this.style.background = 'var(--deepseek-border)';
            this.style.color = 'var(--deepseek-text)';
        };
        
        langButton.onclick = toggleLanguage;
        controls.appendChild(langButton);
    }

    function updateUI() {
        const button = document.getElementById('voice-input');
        if (isListening) {
            button.textContent = 'Voice Input ON';
            button.classList.add('listening');
        } else {
            button.textContent = 'Voice Input OFF';
            button.classList.remove('listening');
        }
    }

    function updateStatus(message, className = '') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = 'status-indicator ' + className;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    document.addEventListener('keydown', (e) => {
        // Ctrl+L –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
        if (e.ctrlKey && e.code === 'KeyL') {
            e.preventDefault();
            toggleLanguage();
        }
        
        // Space –¥–ª—è —Å—Ç–∞—Ä—Ç–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (e.code === 'Space' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('voice-input').click();
        }
        
        // Esc –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        if (e.code === 'Escape' && isListening) {
            stopListening();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('DOMContentLoaded', () => {
        updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...', 'active');
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞
        createLanguageToggle();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
        initializeRecognition();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateStatus('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏');
    });

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('SpeechRecognition –¥–æ—Å—Ç—É–ø–µ–Ω:', !!SpeechRecognition);
    console.log('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏:', navigator.languages);
</script>
    
</body>
</html>
