<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ASR Android 14 Debug</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    padding: 0;
    background: #0f1115;
    color: #e6e6e6;
    font-family: system-ui, sans-serif;
}

.container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
}

button {
    background: #1f2430;
    color: #fff;
    border: 1px solid #2f3545;
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
}

button:hover {
    background: #2a3040;
}

.controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

textarea, pre {
    width: 100%;
    min-height: 180px;
    background: #151821;
    color: #f1f1f1;
    border: 1px solid #2a2f3a;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
}

pre {
    font-size: 12px;
    white-space: pre-wrap;
    overflow: auto;
    color: #9aa0aa;
}

.hidden { display: none; }

.status {
    margin-top: 8px;
    font-size: 12px;
    color: #9aa0aa;
}

.asr-final-blink {
    animation: blink 0.22s ease-in-out;
}

@keyframes blink {
    0% { background: rgba(255,230,140,.35); }
    100% { background: transparent; }
}
</style>
</head>

<body>
<div class="container">
    <h3>ASR Android 14 / Chrome 141 — Debug</h3>

    <div class="controls">
        <button id="tab-asr">ASR</button>
        <button id="tab-logs">Logs</button>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <button id="clear">Clear</button>
    </div>

    <textarea id="asr"></textarea>
    <pre id="logs" class="hidden"></pre>

    <div class="status" id="status">Idle</div>
</div>

<script>
/* ================= DOM ================= */

const asrView = document.getElementById("asr");
const logsView = document.getElementById("logs");
const statusView = document.getElementById("status");

const tabAsrBtn  = document.getElementById("tab-asr");
const tabLogsBtn = document.getElementById("tab-logs");
const startBtn   = document.getElementById("start");
const stopBtn    = document.getElementById("stop");
const clearBtn   = document.getElementById("clear");

/* ================= ENV DETECT ================= */

function detectEnv() {
    const ua = navigator.userAgent;
    return {
        ua,
        isAndroid14: /Android 14/.test(ua),
        chromeVersion: (() => {
            const m = ua.match(/Chrome\/(\d+)/);
            return m ? Number(m[1]) : null;
        })(),
        isTargetBrowser:
    /Chrome\/141\./.test(ua) &&
    /Mobile/.test(ua) &&
    /Android/.test(ua)
    };
}

const env = detectEnv();
log("ENV", env);

/* ================= TABS ================= */

tabAsrBtn.onclick = () => {
    asrView.classList.remove("hidden");
    logsView.classList.add("hidden");
};

tabLogsBtn.onclick = () => {
    asrView.classList.add("hidden");
    logsView.classList.remove("hidden");
};

/* ================= LOGGER ================= */

function log(label, obj) {
    logsView.textContent +=
        `[${label}]\n` +
        JSON.stringify(obj, null, 2) +
        "\n\n";
    logsView.scrollTop = logsView.scrollHeight;
}

/* ================= TYPEWRITER ================= */

function typewriter(textarea, text, moveCaret) {
    const DELAY = 16;
    let i = 0;

    function step() {
        if (i >= text.length) return;
        textarea.value += text[i++];
        if (moveCaret) {
            textarea.selectionStart =
            textarea.selectionEnd = textarea.value.length;
        }
        setTimeout(step, DELAY);
    }
    step();
}

/* ================= WEB SPEECH ================= */

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) {
    log("ERROR", "SpeechRecognition not supported");
    alert("SpeechRecognition not supported");
}

const rec = new SR();
rec.lang = "ru-RU";
rec.interimResults = true;
rec.continuous = true;
rec.maxAlternatives = 1;

let lastFinalIndex = -1;

rec.onstart = () => {
    statusView.textContent = "Listening…";
    lastFinalIndex = -1;
    log("ASR", "start");
};

rec.onend = () => {
    statusView.textContent = "Stopped";
    log("ASR", "end");
};

rec.onerror = e => {
    statusView.textContent = "Error: " + e.error;
    log("ERROR", e);
};

rec.onresult = (event) => {

    log("RAW_EVENT", {
        resultIndex: event.resultIndex,
        results: Array.from(event.results).map((r, i) => ({
            i,
            isFinal: r.isFinal,
            transcript: r[0]?.transcript,
            confidence: r[0]?.confidence
        }))
    });

    for (let i = event.resultIndex; i < event.results.length; i++) {

        if (i <= lastFinalIndex) continue;

        const res = event.results[i];
        if (res.isFinal !== true) continue;

        const alt = res[0];
        const text = alt.transcript?.trim();
        const confidence = alt.confidence ?? 0;

        if (!text) continue;

        if (confidence === 0) {
            // INTERIM
            typewriter(asrView, text + " ", false);
        } else {
            // FINAL
            typewriter(asrView, text + " ", true);
            lastFinalIndex = i;
        }
    }
};

/* ================= CONTROLS ================= */

startBtn.onclick = () => rec.start();
stopBtn.onclick  = () => rec.stop();

clearBtn.onclick = () => {
    asrView.value = "";
    logsView.textContent = "";
};
</script>

</body>
</html>
